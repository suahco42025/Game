<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prime Excellence Daycare School Computer Game</title>
    <meta name="description" content="Fun educational games for kids: mouse training, typing, word spelling, rainbow painting, and fruit dragging! Earn badges at Prime Excellence Daycare School.">
    <meta name="keywords" content="kids computer games, educational typing, preschool mouse skills, daycare games, kids drawing games, drag and drop games">
    <link rel="canonical" href="https://YOUR_DOMAIN_HERE/">
    <link rel="sitemap" type="application/xml" href="/sitemap.xml">
    <link rel="icon" href="Images/favicon.ico" type="image/x-icon">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One:wght@400&display=swap');
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Fredoka One', 'Comic Sans MS', cursive, sans-serif;
            background: 
                radial-gradient(circle at 20% 80%, rgba(86, 171, 47, 0.3) 0%, transparent 50%),
                linear-gradient(135deg, #56ab2f 0%, #a8e6cf 50%, #dcedc1 100%);
            color: #4a4a4a;
            overflow: hidden;
            cursor: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><circle cx='16' cy='16' r='12' fill='%23ffdb4d'/><path d='M16 4c-3 0-6 2-7 5l-1 2c0 1 1 2 2 2h14c1 0 2-1 2-2l-1-2c-1-3-4-5-7-5z' fill='%23333333'/><circle cx='12' cy='10' r='2' fill='white'/><circle cx='20' cy='10' r='2' fill='white'/><circle cx='12' cy='10' r='1' fill='black'/><circle cx='20' cy='10' r='1' fill='black'/><path d='M10 20c0 3 3 5 6 5s6-2 6-5' fill='none' stroke='%23333333' stroke-width='2'/></svg>"), auto;
            animation: bgShift 20s ease-in-out infinite alternate;
        }
        @media (prefers-reduced-motion: no-preference) {
            @keyframes wiggle { 0%, 100% { transform: translate(-50%, -50%) rotate(0deg); } 25% { transform: translate(-50%, -50%) rotate(5deg); } 75% { transform: translate(-50%, -50%) rotate(-5deg); } }
            @keyframes shake { 0%, 100% { transform: translate(-50%, -50%) translateX(0); } 25% { transform: translate(-50%, -50%) translateX(-10px); } 75% { transform: translate(-50%, -50%) translateX(10px); } }
        }
        @keyframes bgShift { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }
        @keyframes bob { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
        @keyframes sparkle { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(2); } }
        @keyframes slideInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes bounceIn { 0% { transform: scale(0.3); opacity: 0; } 50% { transform: scale(1.05); } 70% { transform: scale(0.9); } 100% { transform: scale(1); opacity: 1; } }
        @keyframes confettiFall { 0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
        #school-logo {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 80px;
            height: auto;
            z-index: 50;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.2s;
            animation: bob 2s ease-in-out infinite;
        }
        #school-logo:hover { transform: scale(1.05); }
        #hero-banner {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: block;
            animation: slideInDown 1s ease-out;
        }
        #hero-banner:not([src]) {
            height: 0;
            margin: 0;
        }
        #launcher {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 100;
            width: 90vw;
            max-width: 1200px;
            max-height: 95vh;
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
            animation: fadeIn 1s ease-out;
        }
        #launcher h1 {
            font-size: clamp(28px, 5vw, 48px);
            color: #ff6b35;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        #student-form {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
            animation: bounceIn 0.8s ease-out;
        }
        #student-form input {
            display: block;
            margin: 10px auto;
            padding: 10px;
            font-size: 18px;
            border: 2px solid #4ecdc4;
            border-radius: 10px;
            text-align: center;
            width: 80%;
            max-width: 250px;
            font-family: inherit;
            transition: border-color 0.2s;
        }
        #student-form input:focus { border-color: #ff6b35; outline: none; }
        #student-form button {
            background: #4ecdc4;
            /* Styles moved to .btn and .btn-primary */
        }
        #student-form button:hover { background: #44a08d; }

        /* === New Unified Button Styles === */
        .btn {
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 16px;
            font-family: inherit;
            margin-top: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }
        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .btn-primary { background: #4ecdc4; }
        .btn-primary:hover { background: #44a08d; }
        .btn-secondary { background: #ff6b35; }
        .btn-secondary:hover { background: #e55a2b; }
        .btn-small {
            font-size: 14px;
            padding: 5px 10px;
        }
        /* === End New Button Styles === */

        #session-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        #change-student-btn { /* Now uses .btn classes */
            background: #ff6b35;
        }
        #session-info {
            margin-bottom: 20px;
            font-size: clamp(14px, 2vw, 18px);
            color: #4a4a4a;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 15px;
            word-break: break-word;
        }
        #stars-bar {
            width: 100%;
            height: 10px;
            background: #ddd;
            border-radius: 5px;
            margin-top: 5px;
            overflow: hidden;
        }
        #stars-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffdb4d, #ffd700);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 5px;
        } 
        #badge-btn { /* Now uses .btn classes */
            background: #4ecdc4; 
            font-size: clamp(14px, 2vw, 16px); 
        }
        .game-card {
            padding: 20px;
            font-size: clamp(18px, 3vw, 24px);
            background: linear-gradient(135deg, #ff6b35, #e55a2b);
            color: white;
            border: none;
            border-radius: 25px;
            font-family: inherit;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }
        .game-card-content {
            display: block;
            transition: transform 0.3s ease;
        }
        .game-card:hover .game-card-content {
            transform: translateY(-5px) scale(1.05);
        }
        .game-card::before { /* Shimmer effect */
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        .game-card:hover::before { left: 100%; }
        .game-card:hover { box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
        .game-card:active { transform: scale(0.98); }
        .game-card-icon {
            font-size: 32px;
            display: block;
            margin-bottom: 10px;
        }
        .game-card {
            animation: bounceIn 0.5s ease-out forwards;
            opacity: 0; /* Start hidden for animation */
        }
        #badge-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.8);
            display: none;
            z-index: 200;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
        }
        #badge-gallery {
            background: linear-gradient(135deg, #fff, #f0f8ff);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
            color: #4a4a4a;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        #badge-gallery h2 { 
            color: #ff6b35; 
            animation: sparkle 2s ease-in-out infinite alternate; 
        }
        #badge-gallery button {
            margin-top: 20px;
        }
        .badge-item {
            margin: 10px 0;
            font-size: clamp(18px, 3vw, 24px);
            background: rgba(255, 215, 0, 0.2);
            padding: 10px;
            border-radius: 10px;
        }
        #game-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: none;
            z-index: 1;
            animation: fadeIn 0.5s ease-out;
        }
        .back-btn {
            z-index: 30 !important;
            background: linear-gradient(135deg, #ff6b35, #e55a2b) !important;
            color: white !important;
            border: none !important;
            padding: 12px 20px !important;
            border-radius: 20px !important;
            font-size: 16px !important;
            transition: all 0.2s !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important;
            role: button;
            cursor: pointer;
            position: absolute; /* Added for consistent positioning */
            top: 20px;          /* Added for consistent positioning */
            left: 20px;         /* Added for consistent positioning */
        }
        .back-btn:hover { transform: scale(1.1); box-shadow: 0 6px 12px rgba(0,0,0,0.3); }
        .hud-score, .hud-timer {
            position: absolute;
            font-size: 20px;
            font-weight: bold;
            z-index: 20;
            background: rgba(255,255,255,0.9);
            padding: 5px 10px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            min-width: 150px; /* Ensure a minimum width */
            text-align: center;
        }
        #game-hud {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 15px 110px 15px 15px; /* top, right, bottom, left - Added space on the right for the logo */
            box-sizing: border-box;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            z-index: 30;
            pointer-events: none; /* Allow clicks to pass through the container */
        }
        #game-hud > * {
            pointer-events: all; /* Make sure buttons inside are clickable */
        }
        .hud-left, .hud-center, .hud-right {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }
        .back-btn {
            z-index: 30 !important;
            background: linear-gradient(135deg, #ff6b35, #e55a2b) !important;
            color: white !important;
            border: none !important;
            padding: 12px 20px !important;
            border-radius: 20px !important;
            font-size: 16px !important;
            transition: all 0.2s !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important;
            role: button;
            cursor: pointer;
            position: static; /* Remove absolute positioning */
        }
        .back-btn:hover { transform: scale(1.1); box-shadow: 0 6px 12px rgba(0,0,0,0.3); }
        .hud-score, .hud-timer {
            position: static; /* Remove absolute positioning */
            font-size: 20px;
            font-weight: bold;
            z-index: 20;
            background: rgba(255,255,255,0.9);
            padding: 5px 10px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            max-width: 150px;
            word-wrap: break-word;
        }
        .progress-bar {
            width: 100px;
            height: 8px;
            background: #ddd;
            border-radius: 4px;
            margin-top: 2px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4, #44a08d);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #ffd700;
            pointer-events: none;
            z-index: 100;
            animation: confettiFall 3s linear forwards;
        }
        #mobile-prompt {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #56ab2f, #a8e6cf);
            display: none;
            z-index: 999;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
            font-size: 24px;
            animation: bounceIn 1s ease-out;
        }
        @media (max-width: 768px) {
            #launcher { width: 95vw; padding: 15px; }
            #student-form input { width: 90%; }
            #hero-banner { max-height: 150px; }
            #school-logo { width: 60px; right: 10px; }
        }
        #games-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            width: 100%;
        }
        @media (max-width: 550px) {
            #games-section { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <img id="school-logo" src="Images/Badge.jpg" alt="Prime Excellence Daycare School Logo" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSI0MCIgY3k9IjQwIiByPSI0MCIgZmlsbD0iI2ZmZGI0ZCIvPjx0ZXh0IHg9IjQwIiB5PSI0NSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkNvbWljIFNhbnMgTVMiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiMzMzMzMzMiPlByaW1lIEV4Y2VsbGVuY2U8L3RleHQ+PC9zdmc+'">

    <div id="launcher">
        <img id="hero-banner" src="Images/hero-banner.jpg" alt="Prime Excellence Daycare School - Fun Learning Adventure" onerror="this.style.display='none'; this.parentNode.style.marginTop='0';">

        <h1>Prime Excellence Daycare School Computer Game 🐒</h1>
        
        <div id="student-form">
            <p style="font-size: 18px; margin-bottom: 10px;">Who's playing today? 🐵</p>
            <input type="text" id="student-name" placeholder="Student Name (e.g., Johnny)" value="Super Student">
            <input type="text" id="student-class" placeholder="Class/Session (e.g., Morning Stars)" value="Fun Class">
            <button class="btn btn-primary" onclick="startStudentSession()">Start Adventure! 🚀</button>
        </div>
        
        <div id="games-section-wrapper" style="display: none;">
            <div id="session-info">
                Student: <span id="student-name-display">Super Student</span> | Class: <span id="student-class-display">Fun Class</span> | Sessions: <span id="session-count">0</span> | Badges: <span id="badge-count">0</span> | High Score: <span id="high-score">0</span>
                <div id="stars-bar"><div id="stars-fill"></div></div>
            </div>
            <div id="session-controls">
                <button id="change-student-btn" class="btn btn-secondary btn-small" onclick="showStudentForm()">Change Student 👤</button>
                <button id="badge-btn" class="btn btn-primary btn-small" onclick="showBadges()">View Badges 🏅</button>
            </div>
            <div id="games-section">
                <!-- Simple Creative & Mouse Skills -->
                <button class="game-card" style="animation-delay: 0.1s;" onclick="loadGame(5)" role="button" aria-label="Play Rainbow Painter Game"><span class="game-card-content"><span class="game-card-icon">🌈</span> Rainbow Painter</span></button>
                <button class="game-card" style="animation-delay: 0.2s;" onclick="loadGame(1)" role="button" aria-label="Play Mouse Trainer Game"><span class="game-card-content"><span class="game-card-icon">🎯</span> Mouse Trainer</span></button>
                <button class="game-card" style="animation-delay: 0.3s;" onclick="loadGame(2)" role="button" aria-label="Play Banana Chase Game"><span class="game-card-content"><span class="game-card-icon">🍌</span> Banana Chase</span></button>
                
                <!-- Drag and Drop Skills -->
                <button class="game-card" style="animation-delay: 0.4s;" onclick="loadGame(6)" role="button" aria-label="Play Fruit Drop Adventure Game"><span class="game-card-content"><span class="game-card-icon">🍎</span> Fruit Drop Adventure</span></button>
                <button class="game-card" style="animation-delay: 0.5s;" onclick="loadGame(7)" role="button" aria-label="Play Art Puzzle Game"><span class="game-card-content"><span class="game-card-icon">🎨</span> Art Puzzle</span></button>
                
                <!-- Typing Skills -->
                <button class="game-card" style="animation-delay: 0.6s;" onclick="loadGame(3)" role="button" aria-label="Play Typewriter Game"><span class="game-card-content"><span class="game-card-icon">⌨️</span> Typewriter</span></button>
                <button class="game-card" style="animation-delay: 0.7s;" onclick="loadGame(4)" role="button" aria-label="Play Word Weaver Game"><span class="game-card-content"><span class="game-card-icon">✏️</span> Word Weaver</span></button>
            </div>
        </div>
    </div>

    <div id="badge-modal">
        <div id="badge-gallery">
            <h2>Your School Badges! 🌟</h2>
            <div id="badge-list"></div>
            <button class="btn btn-secondary" onclick="hideBadges()">Close</button>
        </div>
    </div>

    <div id="game-area"></div>

    <div id="mobile-prompt">
        <div>
            <h2>👆 Tap to Play!</h2>
            <p>Touch the screen to start sounds and games. Ooh ooh ah ah!</p>
            <button class="btn btn-primary" onclick="hideMobilePrompt()">Start Adventure! 🎮</button>
        </div>
    </div>

    <script>
        // Global vars
        let soundEnabled = true;
        let globalAudioContext = null;
        let currentStudent = JSON.parse(localStorage.getItem('primeStudentData') || '{"name":"Super Student","class":"Fun Class"}');
        let sessions = parseInt(localStorage.getItem(`primeSessions_${encodeURIComponent(currentStudent.name)}`) || '0');
        let badges = JSON.parse(localStorage.getItem(`primeBadges_${encodeURIComponent(currentStudent.name)}`) || '[]');
        let highScore = parseInt(localStorage.getItem(`primeHighScore_${encodeURIComponent(currentStudent.name)}`) || '0');
        let totalStars = badges.length * 10;
        let currentGame = 0;
        let audioDebounce = null;

        // Helper to format time as MM:SS
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Audio helpers
        function initGlobalAudio() {
            if (!globalAudioContext) {
                globalAudioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (globalAudioContext.state === 'suspended') {
                globalAudioContext.resume();
            }
        }
        function playSound(type) {
            if (!soundEnabled || !globalAudioContext) return;
            initGlobalAudio();
            const o = globalAudioContext.createOscillator();
            const g = globalAudioContext.createGain();
            o.connect(g); g.connect(globalAudioContext.destination);
            if (type === 'hover') { o.frequency.value = 800; g.gain.value = 0.1; o.type = 'sine'; }
            else if (type === 'click') { o.frequency.value = 600; g.gain.value = 0.2; o.type = 'square'; }
            else if (type === 'win') { o.frequency.value = 523; o.frequency.setTargetAtTime(784, globalAudioContext.currentTime + 0.1, 0.1); g.gain.value = 0.15; o.type = 'sine'; }
            g.gain.exponentialRampToValueAtTime(0.01, globalAudioContext.currentTime + 0.3);
            o.start(); o.stop(globalAudioContext.currentTime + 0.3);
        }
        function playTone(f, d, t = 'sine', v = 0.1) {
            if (!globalAudioContext) return;
            initGlobalAudio();
            const o = globalAudioContext.createOscillator();
            const g = globalAudioContext.createGain();
            o.connect(g); g.connect(globalAudioContext.destination);
            o.frequency.setValueAtTime(f, globalAudioContext.currentTime);
            o.type = t;
            g.gain.setValueAtTime(0, globalAudioContext.currentTime);
            g.gain.linearRampToValueAtTime(v, globalAudioContext.currentTime + 0.01);
            g.gain.exponentialRampToValueAtTime(0.01, globalAudioContext.currentTime + d);
            o.start(globalAudioContext.currentTime);
            o.stop(globalAudioContext.currentTime + d);
        }

        // Confetti
        function showConfetti() {
            for (let i = 0; i < 50; i++) {
                const conf = document.createElement('div');
                conf.className = 'confetti';
                conf.style.left = Math.random() * 100 + 'vw';
                conf.style.background = ['#ffd700', '#ff6b35', '#4ecdc4'][Math.floor(Math.random() * 3)];
                conf.style.animationDelay = Math.random() * 0.5 + 's';
                document.body.appendChild(conf);
                setTimeout(() => conf.remove(), 3000);
            }
        }

        // Student functions
        function getSafeKey(key) {
            return `prime${key}_${encodeURIComponent(currentStudent.name)}`;
        }
        function initDisplay() {
            document.getElementById('student-name').value = currentStudent.name;
            document.getElementById('student-class').value = currentStudent.class;
            document.getElementById('student-name-display').textContent = currentStudent.name;
            document.getElementById('student-class-display').textContent = currentStudent.class;
            document.getElementById('session-count').textContent = sessions;
            document.getElementById('badge-count').textContent = badges.length;
            document.getElementById('high-score').textContent = highScore;
            document.getElementById('stars-fill').style.width = Math.min((totalStars / 100) * 100, 100) + '%';
            document.getElementById('student-form').style.display = 'none';
            document.getElementById('games-section-wrapper').style.display = 'block';
        }
        function startStudentSession() {
            const name = document.getElementById('student-name').value.trim();
            const classSession = document.getElementById('student-class').value.trim() || 'Fun Class';
            if (name.length < 1 || name.length > 25) {
                alert('Name must be 1-20 letters! 🐒');
                return;
            }
            const oldName = currentStudent.name;
            currentStudent = { name, class: classSession };
            localStorage.setItem('primeStudentData', JSON.stringify(currentStudent));
            if (oldName !== name) {
                sessions = parseInt(localStorage.getItem(getSafeKey('Sessions')) || '0'); // Use getSafeKey
                badges = JSON.parse(localStorage.getItem(getSafeKey('Badges')) || '[]'); // Use getSafeKey
                highScore = parseInt(localStorage.getItem(getSafeKey('HighScore')) || '0'); // Use getSafeKey
                totalStars = badges.length * 10;
            }
            initDisplay();
            playSound('click');
        }
        function showStudentForm() {
            document.getElementById('student-form').style.display = 'block';
            document.getElementById('games-section-wrapper').style.display = 'none';
        }

        // Mobile
        if (window.matchMedia('(pointer: coarse)').matches) {
            document.getElementById('mobile-prompt').style.display = 'flex';
        }
        function hideMobilePrompt() {
            document.getElementById('mobile-prompt').style.display = 'none';
            initAllAudio();
        }

        // Audio init
        function initAllAudio() {
            clearTimeout(audioDebounce);
            audioDebounce = setTimeout(initGlobalAudio, 100);
        }

        // Award badge
        function awardBadge(gameNum, score, misses) {
            const total = score - misses;
            let badgeType = '';
            if (total >= 100) badgeType = `🏆 ${currentStudent.name}'s Gold Star - Excellence!`;
            else if (total >= 50) badgeType = `⭐ ${currentStudent.name}'s Silver Star - Great Job!`;
            else if (total >= 20) badgeType = `🌟 ${currentStudent.name}'s Bronze Star - Well Done!`;
            else return;

            const badge = { game: gameNum, type: badgeType, date: new Date().toLocaleDateString(), score: total };
            if (!badges.some(b => b.game === gameNum && b.type === badgeType)) {
                badges.push(badge);
                localStorage.setItem(getSafeKey('Badges'), JSON.stringify(badges));
                document.getElementById('badge-count').textContent = badges.length;
                totalStars += 10;
                document.getElementById('stars-fill').style.width = Math.min((totalStars / 100) * 100, 100) + '%';
                alert(`🎉 New Badge Earned: ${badgeType} in Game ${gameNum}! Score: ${total}`);
                showConfetti();
                playSound('win');
            }
            if (total > highScore) {
                highScore = total;
                localStorage.setItem(getSafeKey('HighScore'), highScore);
                document.getElementById('high-score').textContent = highScore;
                alert(`🌟 New High Score for ${currentStudent.name}: ${highScore}!`);
            }
        }

        function showBadges() {
            playSound('hover');
            const list = document.getElementById('badge-list');
            list.innerHTML = badges.map(b => `<div class="badge-item">${b.type} (Game ${b.game}, ${b.date}, Score: ${b.score})</div>`).join('');
            document.getElementById('badge-modal').style.display = 'flex';
        }

        function hideBadges() {
            document.getElementById('badge-modal').style.display = 'none';
        }

        function endSession(gameNum, score, misses) {
            sessions++;
            localStorage.setItem(getSafeKey('Sessions'), sessions);
            document.getElementById('session-count').textContent = sessions;
            awardBadge(gameNum, score, misses);
        }

        // Global keydown handler for Games 3 & 4
        function globalKeyHandler(e) {
            // The new game objects attach their own listeners, but we'll keep this
            // as a potential hook for future global key events.
            // For now, game-specific key handling is inside each game object.
            // Example: if (e.key === 'Escape') backToLauncher();
        }

        // Load game
        function loadGame(gameNum) {
            playSound('click');
            if (window.matchMedia('(pointer: coarse)').matches && !globalAudioContext) {
                alert('Tap the screen first to enable sounds! 👆');
                return;
            }
            document.getElementById('launcher').style.transition = 'opacity 0.5s';
            document.getElementById('launcher').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('launcher').style.display = 'none';
                document.getElementById('game-area').style.display = 'block'; //Fix: removed display of "none" to display of "block"
                // Instead of a number, currentGame will hold the game object
                const game = gameFactory(gameNum);
                if (game) {
                    currentGame = game;
                    game.start(document.getElementById('game-area'));
                }
            }, 500);
        }

        // Back to launcher
        function backToLauncher() {
            playSound('click');
            if (window.clearTimeouts) window.clearTimeouts();
            document.getElementById('game-area').style.transition = 'opacity 0.5s';
            document.getElementById('game-area').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('game-area').innerHTML = '';
                document.getElementById('game-area').style.display = 'none';
                document.getElementById('launcher').style.display = 'block';
                document.getElementById('launcher').style.opacity = '1';
                if (currentGame && typeof currentGame.stop === 'function') {
                    currentGame.stop(); // This was correct, but let's ensure it's called.
                }
                currentGame = null;
                // Remove game-specific event listeners
                window.removeEventListener('keydown', window.gameKeyHandler);
            }, 500);
        }

        // A more modular approach using a "Factory" pattern
        function gameFactory(gameNum) {
            const gameArea = document.getElementById('game-area');

            // Common cleanup function for all games. It should only clear the area.
            const clearGameArea = () => {
                gameArea.innerHTML = '';
            };

            // Game 1: Mouse Trainer
            if (gameNum === 1) {
                 return {
                    score: 0,
                    timeLeft: 300,
                    active: false,
                    timerId: null,
                    currentTarget: null,
                    start: function(container) {
                        clearGameArea();
                        this.stop(); // Clear any previous state

                        this.active = true;
                        this.score = 0;
                        this.timeLeft = 300;
                        
                        const html = `
                            <div id="game-hud">
                                <div class="hud-left"><button class="back-btn" onclick="backToLauncher()" aria-label="Go back home">Swing Home! 🏠</button></div>
                                <div class="hud-center">
                                    <div class="hud-score" id="hud-score1">Score: 0 <div class="progress-bar"><div class="progress-fill" id="score-fill1"></div></div></div>
                                </div>
                                <div class="hud-right"><div class="hud-timer" id="hud-timer1">Time: 5:00 <div class="progress-bar"><div class="progress-fill" id="timer-fill1"></div></div></div></div>
                            </div>
                            <div id="game-over1" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: rgba(0,0,0,0.8); padding: 40px; border-radius: 10px; color: white; display: none;">
                                <h2>Game Over!</h2>
                                <p>Final Score: <span id="final-score1">0</span></p>
                                <button onclick="currentGame.start(document.getElementById('game-area'))">Play Again</button>
                            </div>`;
                        const css = `
                            .target { position: absolute; width: 60px; height: 60px; background: radial-gradient(circle, #ff6b6b, #ee5a24); border-radius: 50%; cursor: pointer; transition: transform 0.1s ease; z-index: 5; }
                            .target:hover { transform: scale(1.1); }
                            .target.clicked { background: radial-gradient(circle, #4ecdc4, #44a08d); transform: scale(0.8); }`;
                        
                        container.innerHTML = html;
                        const styleEl = document.createElement('style');
                        styleEl.textContent = css;
                        container.appendChild(styleEl);

                        this.updateTimer();
                        this.createTarget();
                    },
                    createTarget: function() {
                        if (!this.active) return;
                        if (this.currentTarget) this.currentTarget.remove();
                        const target = document.createElement('div');
                        target.className = 'target';
                        target.style.left = Math.random() * (window.innerWidth - 60) + 'px';
                        target.style.top = Math.random() * (window.innerHeight - 100) + 'px';
                        
                        const handleClick = (e) => {
                            if (e.type === 'touchstart') e.preventDefault();
                            target.classList.add('clicked');
                            this.score++;
                            document.getElementById('hud-score1').innerHTML = `Score: ${this.score} <div class="progress-bar"><div class="progress-fill" id="score-fill1" style="width: ${Math.min((this.score / 50) * 100, 100)}%"></div></div>`;
                            setTimeout(() => target.remove(), 150);
                            this.createTarget();
                        };
                        target.onclick = target.ontouchstart = handleClick;
                        
                        setTimeout(() => { if (target.parentNode && this.active) { target.remove(); this.createTarget(); } }, 2000);
                        gameArea.appendChild(target);
                        this.currentTarget = target;
                    },
                    updateTimer: function() {
                        if (!this.active) return;
                        this.timerId = setTimeout(() => this.updateTimer(), 1000);
                        document.getElementById('hud-timer1').innerHTML = `Time: ${formatTime(this.timeLeft)} <div class="progress-bar"><div class="progress-fill" id="timer-fill1" style="width: ${Math.min((300 - this.timeLeft) / 300 * 100, 100)}%"></div></div>`;
                        this.timeLeft--;
                        if (this.timeLeft < 0) {
                            this.stop();
                            document.getElementById('final-score1').textContent = this.score;
                            document.getElementById('game-over1').style.display = 'block';
                            endSession(1, this.score, 0);
                        }
                    },
                    stop: function() {
                        this.active = false;
                        clearTimeout(this.timerId);
                        if (this.currentTarget) this.currentTarget.remove();
                    }
                };
            } 
            // Game 2: Banana Chase
            if (gameNum === 2) {
                return {
                    score: 0, timeLeft: 300, active: false, timerId: null, currentTarget: null,
                    start: function(container) {
                        clearGameArea(); this.stop();
                        this.active = true; this.score = 0; this.timeLeft = 300;
                        const html = `
                            <div id="game-hud">
                                <div class="hud-left"><button class="back-btn" onclick="backToLauncher()">Swing Home! 🏠</button></div>
                                <div class="hud-center">
                                    <div class="hud-score" id="hud-score2">🍌 Grabbed: 0 <div class="progress-bar"><div class="progress-fill" id="score-fill2"></div></div></div>
                                </div>
                                <div class="hud-right"><div class="hud-timer" id="hud-timer2">Time: 5:00 <div class="progress-bar"><div class="progress-fill" id="timer-fill2"></div></div></div></div>
                            </div>
                            <div id="game-over2" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: rgba(255, 215, 0, 0.9); padding: 40px; border-radius: 20px; color: #4a4a4a; box-shadow: 0 0 20px rgba(0,0,0,0.3); display: none;">
                                <h2>🍌 Jungle Jam! 🍌</h2><p>Final Bananas: <span id="final-score2">0</span></p><button onclick="currentGame.start(document.getElementById('game-area'))">Swing Again!</button>
                            </div>`;
                        const css = `.banana { position: absolute; width: 40px; height: 80px; background: linear-gradient(45deg, #ffd700, #ffed4e); border-radius: 20px 20px 10px 10px; cursor: pointer; transition: transform 0.2s ease; z-index: 5; animation: bob 1.5s ease-in-out infinite; } .banana:hover { transform: scale(1.1) rotate(5deg); } .banana.grabbed { background: linear-gradient(45deg, #4ecdc4, #44a08d); transform: scale(0.9) rotate(-10deg); animation: none; }`;
                        container.innerHTML = html;
                        const styleEl = document.createElement('style'); styleEl.textContent = css; container.appendChild(styleEl);
                        this.updateTimer(); this.createTarget();
                    },
                    createTarget: function() {
                        if (!this.active) return;
                        if (this.currentTarget) this.currentTarget.remove();
                        const target = document.createElement('div'); target.className = 'banana';
                        target.style.left = Math.random() * (window.innerWidth - 40) + 'px';
                        target.style.top = Math.random() * (window.innerHeight - 120) + 'px';
                        const handleClick = (e) => {
                            if (e.type === 'touchstart') e.preventDefault();
                            target.classList.add('grabbed'); this.score++;
                            document.getElementById('hud-score2').innerHTML = `🍌 Grabbed: ${this.score} <div class="progress-bar"><div class="progress-fill" id="score-fill2" style="width: ${Math.min((this.score / 30) * 100, 100)}%"></div></div>`;
                            setTimeout(() => target.remove(), 200); this.createTarget();
                        };
                        target.onclick = target.ontouchstart = handleClick;
                        setTimeout(() => { if (target.parentNode && this.active) { target.remove(); this.createTarget(); } }, 2500);
                        gameArea.appendChild(target); this.currentTarget = target;
                    },
                    updateTimer: function() {
                        if (!this.active) return;
                        this.timerId = setTimeout(() => this.updateTimer(), 1000);
                        document.getElementById('hud-timer2').innerHTML = `Time: ${formatTime(this.timeLeft)} <div class="progress-bar"><div class="progress-fill" id="timer-fill2" style="width: ${Math.min((300 - this.timeLeft) / 300 * 100, 100)}%"></div></div>`;
                        this.timeLeft--;
                        if (this.timeLeft < 0) {
                            this.stop();
                            document.getElementById('final-score2').textContent = this.score;
                            document.getElementById('game-over2').style.display = 'block';
                            endSession(2, this.score, 0);
                        }
                    },
                    stop: function() { this.active = false; clearTimeout(this.timerId); if (this.currentTarget) this.currentTarget.remove(); }
                };
            }
            // Game 3: Typewriter
            if (gameNum === 3) {
                return {
                    score: 0, misses: 0, timeLeft: 300, active: false, timerId: null, letterTimeout: null, currentLetter: 'A',
                    handleKey: function(e) {
                        initGlobalAudio(); if (!this.active) return;
                        const k = e.key.toUpperCase();
                        const letterEl = document.getElementById('current-letter');
                        if (k === this.currentLetter) {
                            clearTimeout(this.letterTimeout); this.score++;
                            document.getElementById('hud-score3').innerHTML = `🍌 Typed: ${this.score} <div class="progress-bar"><div class="progress-fill" id="score-fill3" style="width: ${Math.min((this.score / 30) * 100, 100)}%"></div></div>`;
                            letterEl.classList.add('correct'); playTone(440, 0.3, 'sine', 0.1); playTone(880, 0.3, 'sine', 0.1);
                            setTimeout(() => { letterEl.classList.remove('correct'); this.updateLetter(); }, 300);
                        } else if (/^[A-Z]$/.test(k)) {
                            clearTimeout(this.letterTimeout); this.misses++;
                            document.getElementById('hud-misses3').innerHTML = `❌ Missed: ${this.misses} <div class="progress-bar"><div class="progress-fill" id="miss-fill3" style="background: #ff4757; width: ${Math.min((this.misses / 10) * 100, 100)}%"></div></div>`;
                            letterEl.classList.add('wrong'); playTone(200, 0.2, 'square', 0.05);
                            setTimeout(() => { letterEl.classList.remove('wrong'); this.startLetterTimer(); }, 500);
                        }
                    },
                    start: function(container) {
                        clearGameArea(); this.stop();
                        this.active = true; this.score = 0; this.misses = 0; this.timeLeft = 300;
                        const html = `
                            <div id="game-hud">
                                <div class="hud-left"><button class="back-btn" onclick="backToLauncher()">Swing Home! 🏠</button></div>
                                <div class="hud-center">
                                    <div class="hud-score" id="hud-score3">🍌 Typed: 0 <div class="progress-bar"><div class="progress-fill" id="score-fill3"></div></div></div>
                                    <div class="hud-timer" id="hud-misses3" style="color: #ff4757;">❌ Missed: 0 <div class="progress-bar"><div class="progress-fill" id="miss-fill3" style="background: #ff4757;"></div></div></div>
                                </div>
                                <div class="hud-right"><div class="hud-timer" id="hud-timer3">Time: 5:00 <div class="progress-bar"><div class="progress-fill" id="timer-fill3"></div></div></div></div>
                            </div>
                            <div id="current-letter" style="font-size: 200px; font-weight: bold; color: #ff6b35; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); transition: all 0.3s ease; user-select: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">A</div>
                            <div id="game-over3" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: rgba(255, 215, 0, 0.9); padding: 40px; border-radius: 20px; color: #4a4a4a; display: none;">
                                <h2>🍌 Typewriter Tango Over! 🍌</h2><p>Final Bananas: <span id="final-score3">0</span></p><p>Misses: <span id="final-misses3">0</span></p><button onclick="currentGame.start(document.getElementById('game-area'))">Type Again!</button>
                            </div>`;
                        const css = `#current-letter.correct { color: #4ecdc4; transform: translate(-50%, -50%) scale(1.2); } #current-letter.wrong { color: #ff4757; animation: shake 0.5s ease; }`;
                        container.innerHTML = html;
                        const styleEl = document.createElement('style'); styleEl.textContent = css; container.appendChild(styleEl);
                        window.gameKeyHandler = this.handleKey.bind(this);
                        window.addEventListener('keydown', window.gameKeyHandler);
                        this.updateLetter(); this.updateTimer();
                    },
                    updateLetter: function() {
                        this.currentLetter = String.fromCharCode(65 + Math.floor(Math.random() * 26));
                        document.getElementById('current-letter').textContent = this.currentLetter;
                        this.startLetterTimer();
                    },
                    startLetterTimer: function() {
                        clearTimeout(this.letterTimeout);
                        this.letterTimeout = setTimeout(() => {
                            if (!this.active) return;
                            this.misses++;
                            document.getElementById('hud-misses3').innerHTML = `❌ Missed: ${this.misses} <div class="progress-bar"><div class="progress-fill" id="miss-fill3" style="background: #ff4757; width: ${Math.min((this.misses / 10) * 100, 100)}%"></div></div>`;
                            const letterEl = document.getElementById('current-letter');
                            letterEl.classList.add('wrong'); playTone(200, 0.2, 'square', 0.05);
                            setTimeout(() => { letterEl.classList.remove('wrong'); this.updateLetter(); }, 500);
                        }, 3000);
                    },
                    updateTimer: function() {
                        if (!this.active) return;
                        this.timerId = setTimeout(() => this.updateTimer(), 1000);
                        document.getElementById('hud-timer3').innerHTML = `Time: ${formatTime(this.timeLeft)} <div class="progress-bar"><div class="progress-fill" id="timer-fill3" style="width: ${Math.min((300 - this.timeLeft) / 300 * 100, 100)}%"></div></div>`;
                        this.timeLeft--;
                        if (this.timeLeft < 0) {
                            this.stop();
                            document.getElementById('final-score3').textContent = this.score;
                            document.getElementById('final-misses3').textContent = this.misses;
                            document.getElementById('game-over3').style.display = 'block';
                            endSession(3, this.score, this.misses);
                        }
                    },
                    stop: function() { this.active = false; clearTimeout(this.timerId); clearTimeout(this.letterTimeout); window.removeEventListener('keydown', window.gameKeyHandler); }
                };
            }
            // Game 4: Word Weaver
            if (gameNum === 4) {
                return {
                    score: 0, misses: 0, timeLeft: 300, active: false, timerId: null, wordTimeout: null, currentWord: '', typedSoFar: '',
                    wordList: ['BANANA', 'MONKEY', 'SWING', 'VINE', 'TREE', 'FRUIT', 'CHASE', 'JUNGLE', 'OOH', 'AHH'],
                    handleKey: function(e) {
                        initGlobalAudio(); if (!this.active) return;
                        const k = e.key.toUpperCase();
                        const wordEl = document.getElementById('current-word');
                        if (/^[A-Z]$/.test(k)) {
                            if (this.typedSoFar + k === this.currentWord) {
                                clearTimeout(this.wordTimeout); this.score++;
                                document.getElementById('hud-score4').innerHTML = `🍌 Words: ${this.score} <div class="progress-bar"><div class="progress-fill" id="score-fill4" style="width: ${Math.min((this.score / 20) * 100, 100)}%"></div></div>`;
                                wordEl.classList.add('correct'); playTone(440, 0.4, 'sine', 0.1); playTone(880, 0.4, 'sine', 0.1);
                                setTimeout(() => { wordEl.classList.remove('correct'); this.updateWord(); }, 400);
                            } else if (this.currentWord.startsWith(this.typedSoFar + k)) {
                                this.typedSoFar += k;
                                document.getElementById('typed-so-far').textContent = this.typedSoFar;
                            } else {
                                clearTimeout(this.wordTimeout); this.misses++;
                                document.getElementById('hud-misses4').innerHTML = `❌ Missed: ${this.misses} <div class="progress-bar"><div class="progress-fill" id="miss-fill4" style="background: #ff4757; width: ${Math.min((this.misses / 10) * 100, 100)}%"></div></div>`;
                                wordEl.classList.add('wrong'); playTone(200, 0.3, 'square', 0.05);
                                this.typedSoFar = ''; document.getElementById('typed-so-far').textContent = '';
                                setTimeout(() => { wordEl.classList.remove('wrong'); this.startWordTimer(); }, 500);
                            }
                        }
                    },
                    start: function(container) {
                        clearGameArea(); this.stop();
                        this.active = true; this.score = 0; this.misses = 0; this.timeLeft = 300;
                        const html = `
                            <div id="game-hud">
                                <div class="hud-left"><button class="back-btn" onclick="backToLauncher()">Swing Home! 🏠</button></div>
                                <div class="hud-center">
                                    <div class="hud-score" id="hud-score4">🍌 Words: 0 <div class="progress-bar"><div class="progress-fill" id="score-fill4"></div></div></div>
                                    <div class="hud-timer" id="hud-misses4" style="color: #ff4757;">❌ Missed: 0 <div class="progress-bar"><div class="progress-fill" id="miss-fill4" style="background: #ff4757;"></div></div></div>
                                </div>
                                <div class="hud-right"><div class="hud-timer" id="hud-timer4">Time: 5:00 <div class="progress-bar"><div class="progress-fill" id="timer-fill4"></div></div></div></div>
                            </div>
                            <div id="current-word" style="font-size: 120px; font-weight: bold; color: #ff6b35; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); user-select: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);"></div>
                            <div id="typed-so-far" style="position: absolute; top: 45%; left: 50%; transform: translate(-50%, 0); font-size: 40px; color: #4ecdc4; z-index: 10;"></div>
                            <div id="game-over4" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: rgba(255, 215, 0, 0.9); padding: 40px; border-radius: 20px; color: #4a4a4a; display: none;">
                                <h2>🍌 Word Weaver Womp! 🍌</h2><p>Final Words: <span id="final-score4">0</span></p><p>Misses: <span id="final-misses4">0</span></p><button onclick="currentGame.start(document.getElementById('game-area'))">Weave Again!</button>
                            </div>`;
                        const css = `#current-word.correct { color: #4ecdc4; transform: translate(-50%, -50%) scale(1.1); } #current-word.wrong { color: #ff4757; animation: shake 0.5s ease; }`;
                        container.innerHTML = html;
                        const styleEl = document.createElement('style'); styleEl.textContent = css; container.appendChild(styleEl);
                        window.gameKeyHandler = this.handleKey.bind(this);
                        window.addEventListener('keydown', window.gameKeyHandler);
                        this.updateWord(); this.updateTimer();
                    },
                    updateWord: function() {
                        this.currentWord = this.wordList[Math.floor(Math.random() * this.wordList.length)];
                        this.typedSoFar = '';
                        document.getElementById('current-word').textContent = this.currentWord;
                        document.getElementById('typed-so-far').textContent = '';
                        this.startWordTimer();
                    },
                    startWordTimer: function() {
                        clearTimeout(this.wordTimeout);
                        this.wordTimeout = setTimeout(() => {
                            if (!this.active) return; this.misses++;
                            document.getElementById('hud-misses4').innerHTML = `❌ Missed: ${this.misses} <div class="progress-bar"><div class="progress-fill" id="miss-fill4" style="background: #ff4757; width: ${Math.min((this.misses / 10) * 100, 100)}%"></div></div>`;
                            const wordEl = document.getElementById('current-word');
                            wordEl.classList.add('wrong'); playTone(200, 0.3, 'square', 0.05);
                            this.typedSoFar = ''; document.getElementById('typed-so-far').textContent = '';
                            setTimeout(() => { wordEl.classList.remove('wrong'); this.updateWord(); }, 500);
                        }, 5000);
                    },
                    updateTimer: function() {
                        if (!this.active) return;
                        this.timerId = setTimeout(() => this.updateTimer(), 1000);
                        document.getElementById('hud-timer4').innerHTML = `Time: ${formatTime(this.timeLeft)} <div class="progress-bar"><div class="progress-fill" id="timer-fill4" style="width: ${Math.min((300 - this.timeLeft) / 300 * 100, 100)}%"></div></div>`;
                        this.timeLeft--;
                        if (this.timeLeft < 0) {
                            this.stop();
                            document.getElementById('final-score4').textContent = this.score;
                            document.getElementById('final-misses4').textContent = this.misses;
                            document.getElementById('game-over4').style.display = 'block';
                            endSession(4, this.score, this.misses);
                        }
                    },
                    stop: function() { this.active = false; clearTimeout(this.timerId); clearTimeout(this.wordTimeout); window.removeEventListener('keydown', window.gameKeyHandler); }
                };
            }
            // Game 5: Rainbow Painter
            if (gameNum === 5) {
                return {
                    score: 0, misses: 0, timeLeft: 300, active: false, timerId: null, canvas: null, ctx: null, isDrawing: false, lastX: 0, lastY: 0, usedColors: new Set(),
                    rainbowColors: ['#ff0000', '#ff7f00', '#ffff00', '#00ff00', '#0000ff', '#4b0082', '#9400d3'],
                    start: function(container) {
                        clearGameArea(); this.stop();
                        this.active = true; this.score = 0; this.misses = 0; this.timeLeft = 300; this.usedColors.clear();
                        const html = `
                            <div id="game-hud">
                                <div class="hud-left"><button class="back-btn" onclick="backToLauncher()">Swing Home! 🏠</button></div>
                                <div class="hud-center">
                                    <div class="hud-score" id="hud-score5">🌈 Colors: 0 <div class="progress-bar"><div class="progress-fill" id="score-fill5"></div></div></div>
                                </div>
                                <div class="hud-right"><div class="hud-timer" id="hud-timer5">Time: 5:00 <div class="progress-bar"><div class="progress-fill" id="timer-fill5"></div></div></div></div>
                            </div>
                            <canvas id="paintCanvas" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 3px dashed #ff6b35; background: #fff; cursor: crosshair; touch-action: none;"></canvas>
                            <div id="game-over5" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: rgba(255, 192, 203, 0.9); padding: 40px; border-radius: 20px; color: #4a4a4a; display: none;">
                                <h2>🌈 Masterpiece Complete! 🌈</h2><p>Final Score: <span id="final-score5">0</span></p><button onclick="currentGame.start(document.getElementById('game-area'))">Paint Again!</button>
                            </div>`;
                        container.innerHTML = html;
                        this.canvas = document.getElementById('paintCanvas'); this.ctx = this.canvas.getContext('2d');
                        this.resizeCanvas();
                        window.addEventListener('resize', this.resizeCanvas.bind(this));
                        this.canvas.addEventListener('mousedown', this.handleStart.bind(this)); this.canvas.addEventListener('mousemove', this.handleMove.bind(this)); this.canvas.addEventListener('mouseup', this.handleEnd.bind(this)); this.canvas.addEventListener('mouseleave', this.handleEnd.bind(this));
                        this.canvas.addEventListener('touchstart', this.handleStart.bind(this)); this.canvas.addEventListener('touchmove', this.handleMove.bind(this)); this.canvas.addEventListener('touchend', this.handleEnd.bind(this));
                        this.updateTimer();
                    },
                    resizeCanvas: function() { this.canvas.width = window.innerWidth; this.canvas.height = window.innerHeight; },
                    handleStart: function(e) { initGlobalAudio(); if (!this.active) return; e.preventDefault(); this.isDrawing = true; const rect = this.canvas.getBoundingClientRect(); this.lastX = (e.type.includes('touch') ? e.touches[0].clientX : e.clientX) - rect.left; this.lastY = (e.type.includes('touch') ? e.touches[0].clientY : e.clientY) - rect.top; },
                    handleMove: function(e) {
                        if (!this.isDrawing || !this.active) return; e.preventDefault(); const rect = this.canvas.getBoundingClientRect();
                        const x = (e.type.includes('touch') ? e.touches[0].clientX : e.clientX) - rect.left; const y = (e.type.includes('touch') ? e.touches[0].clientY : e.clientY) - rect.top;
                        const color = this.rainbowColors[Math.floor(Math.random() * this.rainbowColors.length)];
                        this.ctx.strokeStyle = color; this.ctx.lineWidth = 8 + Math.random() * 4; this.ctx.lineCap = 'round'; this.ctx.beginPath(); this.ctx.moveTo(this.lastX, this.lastY); this.ctx.lineTo(x, y); this.ctx.stroke();
                        if (!this.usedColors.has(color)) { this.usedColors.add(color); this.score = this.usedColors.size; document.getElementById('hud-score5').innerHTML = `🌈 Colors: ${this.score} <div class="progress-bar"><div class="progress-fill" id="score-fill5" style="width: ${Math.min((this.score / 7) * 100, 100)}%"></div></div>`; playTone(523 + Math.random() * 200, 0.1, 'sine', 0.05); }
                        this.lastX = x; this.lastY = y;
                    },
                    handleEnd: function(e) { e.preventDefault(); this.isDrawing = false; },
                    updateTimer: function() {
                        if (!this.active) return; this.timerId = setTimeout(() => this.updateTimer(), 1000);
                        document.getElementById('hud-timer5').innerHTML = `Time: ${formatTime(this.timeLeft)} <div class="progress-bar"><div class="progress-fill" id="timer-fill5" style="width: ${Math.min((300 - this.timeLeft) / 300 * 100, 100)}%"></div></div>`;
                        this.timeLeft--;
                        if (this.timeLeft < 0) { this.stop(); document.getElementById('final-score5').textContent = this.score; document.getElementById('game-over5').style.display = 'block'; endSession(5, this.score, 0); }
                    },
                    stop: function() { this.active = false; this.isDrawing = false; clearTimeout(this.timerId); window.removeEventListener('resize', this.resizeCanvas); }
                };
            }
            // Game 6: Fruit Drop
            if (gameNum === 6) {
                return {
                    score: 0, misses: 0, timeLeft: 300, active: false, timerId: null, fruitTimeout: null, currentFruit: null,
                    fruits: ['🍎', '🍌', '🍊', '🍇'], fruitTypes: ['apple', 'banana', 'orange', 'grape'],
                    start: function(container) {
                        clearGameArea(); this.stop();
                        this.active = true; this.score = 0; this.misses = 0; this.timeLeft = 300;
                        const html = `
                            <div id="game-hud">
                                <div class="hud-left"><button class="back-btn" onclick="backToLauncher()">Swing Home! 🏠</button></div>
                                <div class="hud-center">
                                    <div class="hud-score" id="hud-score6">🍎 Dropped: 0 <div class="progress-bar"><div class="progress-fill" id="score-fill6"></div></div></div>
                                    <div class="hud-timer" id="hud-misses6" style="color: #ff4757;">❌ Wrong: 0 <div class="progress-bar"><div class="progress-fill" id="miss-fill6" style="background: #ff4757;"></div></div></div>
                                </div>
                                <div class="hud-right"><div class="hud-timer" id="hud-timer6">Time: 5:00 <div class="progress-bar"><div class="progress-fill" id="timer-fill6"></div></div></div></div>
                            </div>
                            <div id="monkeys6" style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 20px; z-index: 5;"></div>
                            <div id="game-over6" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: rgba(255, 215, 0, 0.9); padding: 40px; border-radius: 20px; color: #4a4a4a; display: none;">
                                <h2>🍎 Feeding Frenzy Over! 🍎</h2><p>Final Fruits: <span id="final-score6">0</span></p><p>Wrong Drops: <span id="final-misses6">0</span></p><button onclick="currentGame.start(document.getElementById('game-area'))">Feed Again!</button>
                            </div>`;
                        const css = `.fruit { position: absolute; font-size: 40px; cursor: grab; transition: transform 0.2s; z-index: 6; user-select: none; } .fruit.dragging { transform: rotate(10deg) scale(1.1); opacity: 0.8; } .monkey-slot { width: 80px; height: 80px; border: 3px dashed #ff6b35; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; margin: 10px 0; transition: all 0.3s; } .monkey-slot.drop-success { border-color: #4ecdc4; background: rgba(78, 205, 196, 0.2); transform: scale(1.1); } .monkey-slot.drop-fail { border-color: #ff4757; background: rgba(255, 71, 87, 0.2); animation: shake 0.5s ease; }`;
                        container.innerHTML = html;
                        const styleEl = document.createElement('style'); styleEl.textContent = css; container.appendChild(styleEl);
                        const monkeysEl = document.getElementById('monkeys6');
                        this.fruitTypes.forEach(type => {
                            const slot = document.createElement('div'); slot.className = 'monkey-slot'; slot.textContent = '🐵'; slot.dataset.fruit = type;
                            slot.addEventListener('dragover', e => e.preventDefault());
                            slot.addEventListener('drop', this.handleDrop.bind(this));
                            monkeysEl.appendChild(slot);
                        });
                        this.createFruit(); this.updateTimer();
                    },
                    createFruit: function() {
                        if (!this.active) return; if (this.currentFruit) this.currentFruit.remove();
                        const idx = Math.floor(Math.random() * this.fruits.length);
                        const fruit = document.createElement('div'); fruit.className = 'fruit'; fruit.draggable = true; fruit.textContent = this.fruits[idx]; fruit.dataset.fruit = this.fruitTypes[idx];
                        fruit.style.left = '60px'; fruit.style.top = (Math.random() * (window.innerHeight - 100)) + 'px';
                        fruit.addEventListener('dragstart', (e) => { fruit.classList.add('dragging'); e.dataTransfer.setData('text/plain', fruit.dataset.fruit); });
                        fruit.addEventListener('dragend', () => fruit.classList.remove('dragging'));
                        gameArea.appendChild(fruit); this.currentFruit = fruit;
                    },
                    handleDrop: function(e) {
                        e.preventDefault(); if (!this.active) return;
                        const droppedFruit = e.dataTransfer.getData('text/plain');
                        const slotFruit = e.target.dataset.fruit;
                        if (droppedFruit === slotFruit) {
                            this.score++; document.getElementById('hud-score6').innerHTML = `🍎 Dropped: ${this.score} <div class="progress-bar"><div class="progress-fill" id="score-fill6" style="width: ${Math.min((this.score / 20) * 100, 100)}%"></div></div>`;
                            e.target.classList.add('drop-success'); playTone(659, 0.2, 'sine', 0.1);
                            setTimeout(() => e.target.classList.remove('drop-success'), 500);
                        } else {
                            this.misses++; document.getElementById('hud-misses6').innerHTML = `❌ Wrong: ${this.misses} <div class="progress-bar"><div class="progress-fill" id="miss-fill6" style="background: #ff4757; width: ${Math.min((this.misses / 10) * 100, 100)}%"></div></div>`;
                            e.target.classList.add('drop-fail'); playTone(200, 0.3, 'square', 0.05);
                            setTimeout(() => e.target.classList.remove('drop-fail'), 500);
                        }
                        this.createFruit();
                    },
                    updateTimer: function() {
                        if (!this.active) return; this.timerId = setTimeout(() => this.updateTimer(), 1000);
                        document.getElementById('hud-timer6').innerHTML = `Time: ${formatTime(this.timeLeft)} <div class="progress-bar"><div class="progress-fill" id="timer-fill6" style="width: ${Math.min((300 - this.timeLeft) / 300 * 100, 100)}%"></div></div>`;
                        this.timeLeft--;
                        if (this.timeLeft < 0) { this.stop(); document.getElementById('final-score6').textContent = this.score; document.getElementById('final-misses6').textContent = this.misses; document.getElementById('game-over6').style.display = 'block'; endSession(6, this.score, this.misses); }
                    },
                    stop: function() { this.active = false; clearTimeout(this.timerId); if (this.currentFruit) this.currentFruit.remove(); }
                };
            }
            // Game 7: Art Puzzle
            if (gameNum === 7) {
                return {
                    score: 0, misses: 0, timeLeft: 300, active: false, timerId: null, piecesPlacedThisRound: 0,
                    artPieces: [
                        { id: 'piece1', src: 'Arts/Keyboard.png', name: 'Keyboard' },
                        { id: 'piece2', src: 'Arts/Mouse.png', name: 'Mouse' },
                        { id: 'piece3', src: 'Arts/Monitor.png', name: 'Monitor' },
                        { id: 'piece4', src: 'Arts/System Unit.png', name: 'System Unit' },
                        { id: 'piece5', src: 'Arts/Hand on mouse.png', name: 'Hand on Mouse' }
                    ],
                    start: function(container) {
                        clearGameArea(); this.stop();
                        this.active = true; this.score = 0; this.misses = 0; this.timeLeft = 300; this.piecesPlacedThisRound = 0;
                        const html = `
                            <div id="game-hud">
                                <div class="hud-left"><button class="back-btn" onclick="backToLauncher()">Swing Home! 🏠</button></div>
                                <div class="hud-center">
                                    <div class="hud-score" id="hud-score7">🎨 Pieces: 0 <div class="progress-bar"><div class="progress-fill" id="score-fill7"></div></div></div>
                                    <div class="hud-timer" id="hud-misses7" style="color: #ff4757;">❌ Missed: 0 <div class="progress-bar"><div class="progress-fill" id="miss-fill7" style="background: #ff4757;"></div></div></div>
                                </div>
                                <div class="hud-right"><div class="hud-timer" id="hud-timer7">Time: 5:00 <div class="progress-bar"><div class="progress-fill" id="timer-fill7"></div></div></div></div>
                            </div>
                            <div id="art-palette"></div>
                            <div id="art-canvas"></div>
                            <div id="game-over7" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: rgba(135, 206, 235, 0.9); padding: 40px; border-radius: 20px; color: #4a4a4a; display: none;">
                                <h2>🎨 Puzzle Perfect! 🎨</h2><p>Final Score: <span id="final-score7">0</span></p><p>Misses: <span id="final-misses7">0</span></p><button onclick="currentGame.start(document.getElementById('game-area'))">Create Again!</button>
                            </div>`;
                        const css = `
                            @keyframes colorful-border {
                                0% { border-color: #ff6b6b; } 25% { border-color: #feca57; } 50% { border-color: #48dbfb; } 75% { border-color: #ff9ff3; } 100% { border-color: #ff6b6b; }
                            }
                            #art-palette { position: absolute; top: 50%; left: 20px; transform: translateY(-50%); background: rgba(255,255,255,0.8); padding: 10px; border-radius: 15px; display: flex; flex-direction: column; gap: 15px; z-index: 10; }
                            .art-piece { width: 80px; height: 80px; cursor: grab; transition: all 0.2s; user-select: none; object-fit: contain; }
                            .art-piece:hover { transform: scale(1.1); }
                            .art-piece.dragging { opacity: 0.5; transform: scale(1.2); cursor: grabbing; }
                            .art-piece.placed { display: none; } /* Hide from palette once placed */
                            .art-slot { position: absolute; width: 150px; height: 100px; border: 3px dashed #a8e6cf; border-radius: 10px; background-size: contain; background-repeat: no-repeat; background-position: center; transition: all 0.3s; animation: colorful-border 4s linear infinite; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #4a4a4a; background-color: rgba(255,255,255,0.7); }
                            .art-slot.drop-success { border-color: #4ecdc4; background-color: rgba(78, 205, 196, 0.3); transform: scale(1.05); }
                            .art-slot.drop-fail { border-color: #ff4757; background-color: rgba(255, 71, 87, 0.3); animation: shake 0.5s ease; }
                        `;
                        container.innerHTML = html;
                        const styleEl = document.createElement('style'); styleEl.textContent = css; container.appendChild(styleEl);
                        
                        this.setupPuzzle();
                        this.updateTimer();
                    },
                    setupPuzzle: function() {
                        const palette = document.getElementById('art-palette');
                        const canvas = document.getElementById('art-canvas');
                        palette.innerHTML = ''; canvas.innerHTML = '';
                        this.piecesPlacedThisRound = 0; // Reset for the new puzzle

                        const shuffledPieces = [...this.artPieces].sort(() => Math.random() - 0.5);
                        const shuffledSlots = [...this.artPieces].sort(() => Math.random() - 0.5);

                        shuffledPieces.forEach(p => {
                            const pieceEl = document.createElement('img');
                            pieceEl.className = 'art-piece';
                            pieceEl.src = p.src;
                            pieceEl.alt = p.name;
                            pieceEl.dataset.id = p.id;
                            pieceEl.draggable = true;
                            pieceEl.addEventListener('dragstart', e => {
                                e.target.classList.add('dragging');
                                e.dataTransfer.setData('text/plain', e.target.dataset.id);
                            });
                            pieceEl.addEventListener('dragend', e => e.target.classList.remove('dragging'));
                            palette.appendChild(pieceEl);
                        });

                        shuffledSlots.forEach((p, i) => {
                            const slotEl = document.createElement('div');
                            slotEl.className = 'art-slot';
                            slotEl.dataset.id = p.id;
                            slotEl.textContent = p.name; // Display the name/spelling
                            // Position slots randomly on the canvas area
                            slotEl.style.top = `${10 + Math.random() * 75}%`;
                            slotEl.style.left = `${20 + Math.random() * 65}%`;

                            slotEl.addEventListener('dragover', e => e.preventDefault());
                            slotEl.addEventListener('drop', this.handleDrop.bind(this));
                            canvas.appendChild(slotEl);
                        });
                    },
                    handleDrop: function(e) {
                        e.preventDefault(); if (!this.active) return;
                        const droppedId = e.dataTransfer.getData('text/plain');
                        const slot = e.target;
                        const correctPiece = this.artPieces.find(p => p.id === droppedId);

                        if (droppedId === slot.dataset.id) {
                            this.score++; this.piecesPlacedThisRound++;
                            document.getElementById('hud-score7').innerHTML = `🎨 Pieces: ${this.score} <div class="progress-bar"><div class="progress-fill" id="score-fill7" style="width: ${Math.min((this.score / 50) * 100, 100)}%"></div></div>`;
                            slot.classList.add('drop-success'); playTone(659, 0.2, 'sine', 0.1);
                            slot.textContent = ''; // Remove the word
                            slot.style.backgroundImage = `url(${correctPiece.src})`; // Show the image
                            document.querySelector(`.art-piece[data-id='${droppedId}']`).classList.add('placed');
                            if (this.piecesPlacedThisRound === this.artPieces.length) { setTimeout(() => { this.setupPuzzle(); }, 500); }
                        } else {
                            this.misses++; document.getElementById('hud-misses7').innerHTML = `❌ Missed: ${this.misses} <div class="progress-bar"><div class="progress-fill" id="miss-fill7" style="background: #ff4757; width: ${Math.min((this.misses / 5) * 100, 100)}%"></div></div>`;
                            slot.classList.add('drop-fail'); playTone(200, 0.3, 'square', 0.05);
                            setTimeout(() => slot.classList.remove('drop-fail'), 500);
                        }
                    },
                    updateTimer: function() {
                        if (!this.active) return; this.timerId = setTimeout(() => this.updateTimer(), 1000);
                        document.getElementById('hud-timer7').innerHTML = `Time: ${formatTime(this.timeLeft)} <div class="progress-bar"><div class="progress-fill" id="timer-fill7" style="width: ${Math.min((300 - this.timeLeft) / 300 * 100, 100)}%"></div></div>`;
                        this.timeLeft--;
                        if (this.timeLeft < 0) { this.stop(); document.getElementById('final-score7').textContent = this.score; document.getElementById('final-misses7').textContent = this.misses; document.getElementById('game-over7').style.display = 'block'; endSession(7, this.score, this.misses); }
                    },
                    stop: function() { this.active = false; clearTimeout(this.timerId); }
                };
            }
            return null; // Return null if game not found
        }

        window.clearTimeouts = function() {
            // This becomes much simpler. The backToLauncher function handles this.
            // We can also be more robust by clearing all possible timeouts.
            let id = window.setTimeout(function() {}, 0);
            while (id--) {
                window.clearTimeout(id);
            }
        };

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            document.addEventListener('keydown', globalKeyHandler);
            if (currentStudent.name !== 'Super Student' || currentStudent.class !== 'Fun Class') {
                initDisplay();
            }
        });
    </script>
</body>
</html>
